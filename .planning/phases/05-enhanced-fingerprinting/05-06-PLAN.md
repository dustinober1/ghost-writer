---
phase: 05-enhanced-fingerprinting
plan: 06
type: execute
wave: 4
depends_on: [05-05]
files_modified:
  - backend/app/api/routes/fingerprint.py
  - backend/app/services/fingerprint_service.py
  - frontend/src/services/api.ts
  - frontend/src/components/ProfileManager/DriftAlerts.tsx
  - frontend/src/components/ProfileManager/ProfileManager.tsx
autonomous: false

must_haves:
  truths:
    - "User receives alerts when writing style drifts significantly from fingerprint baseline"
    - "Alert severity levels: 'warning' (z-score >=2.0) and 'alert' (z-score >=3.0)"
    - "Alerts include confidence interval showing baseline range and current similarity"
    - "Alerts show changed_features list highlighting which stylometric features deviated most"
    - "User can acknowledge alerts to dismiss them from the active list"
  artifacts:
    - path: "backend/app/api/routes/fingerprint.py"
      provides: "Drift detection endpoints: GET /drift/alerts, POST /drift/acknowledge/{id}"
      exports: ["get_drift_alerts", "acknowledge_alert", "check_drift_on_text"]
    - path: "backend/app/services/fingerprint_service.py"
      provides: "Service methods for drift detection operations"
      exports: ["get_drift_detector", "check_drift_and_create_alert", "get_drift_alerts", "acknowledge_alert"]
    - path: "frontend/src/services/api.ts"
      provides: "Frontend drift API methods"
      exports: ["driftAPI.getAlerts", "driftAPI.checkDrift", "driftAPI.acknowledgeAlert"]
    - path: "frontend/src/components/ProfileManager/DriftAlerts.tsx"
      provides: "Drift alerts list with severity indicators and feature breakdown"
      min_lines: 200
  key_links:
    - from: "backend/app/api/routes/fingerprint.py"
      to: "StyleDriftDetector"
      via: "drift detection service integration"
      pattern: "StyleDriftDetector.*check_drift"
    - from: "frontend/src/components/ProfileManager/DriftAlerts.tsx"
      to: "/api/fingerprint/drift/*"
      via: "driftAPI methods in api.ts"
      pattern: "driftAPI\\."
    - from: "backend/app/services/fingerprint_service.py"
      to: "DriftAlert database table"
      via: "SQLAlchemy ORM for alert persistence"
      pattern: "DriftAlert.*user_id"
---

<objective>
Build drift detection API and UI for style change alerts.

Purpose: Users need visibility into when their writing style drifts significantly from their fingerprint baseline. The API provides endpoints for checking drift, retrieving alerts, and acknowledging them. The UI displays alerts with severity levels, confidence intervals, and feature attribution.

Output: Drift detection API endpoints, FingerprintService methods, frontend API integration, and DriftAlerts React component with human verification checkpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enhanced-fingerprinting/05-enhanced-fingerprinting-RESEARCH.md

@.planning/phases/05-enhanced-fingerprinting/05-05-PLAN.md
@backend/app/ml/fingerprint/drift_detector.py
@backend/app/api/routes/fingerprint.py
@backend/app/services/fingerprint_service.py
@frontend/src/services/api.ts
@frontend/src/components/ProfileManager/ProfileManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add drift detection API endpoints</name>
  <files>backend/app/api/routes/fingerprint.py</files>
  <action>
    Add to backend/app/api/routes/fingerprint.py:

    1. **Add imports**:
       - from app.models.schemas import DriftDetectionResult, DriftAlertResponse, DriftAlertsList
       - from app.models.database import DriftAlert
       - from app.ml.fingerprint.drift_detector import StyleDriftDetector

    2. **GET /api/fingerprint/drift/alerts** - List user's drift alerts:
       ```python
       @router.get("/drift/alerts", response_model=DriftAlertsList)
       async def get_drift_alerts(
           include_acknowledged: bool = False,
           current_user: User = Depends(get_current_user),
           db: Session = Depends(get_db)
       ):
           """
           Get drift alerts for current user.
           include_acknowledged: If False, only return unacknowledged alerts
           """
       ```
       - Query DriftAlert where user_id = current_user.id
       - Filter by acknowledged=False if not include_acknowledged
       - Order by created_at DESC
       - Return DriftAlertsList with total count and unacknowledged_count

    3. **POST /api/fingerprint/drift/check** - Check text for drift:
       ```python
       @router.post("/drift/check", response_model=DriftDetectionResult)
       async def check_drift_on_text(
           request: FingerprintComparisonRequest,
           current_user: User = Depends(get_current_user),
           db: Session = Depends(get_db)
       ):
           """
           Check if text indicates style drift from user's fingerprint.
           Creates an alert if drift is detected.
           """
       ```
       - Get user's EnhancedFingerprint
       - Get or create StyleDriftDetector for user (cached per user session)
       - Compare text to fingerprint using FingerprintComparator
       - Check drift using detector.check_drift()
       - If drift_detected: create DriftAlert record
       - Return DriftDetectionResult

    4. **POST /api/fingerprint/drift/acknowledge/{alert_id}** - Acknowledge alert:
       ```python
       @router.post("/drift/acknowledge/{alert_id}")
       async def acknowledge_alert(
           alert_id: int,
           update_baseline: bool = False,
           current_user: User = Depends(get_current_user),
           db: Session = Depends(get_db)
       ):
           """
           Acknowledge a drift alert.
           update_baseline: If True, recalculate baseline from recent similarities
           """
       ```
       - Validate alert belongs to user
       - Set acknowledged = True
       - If update_baseline: call detector.update_baseline()
       - Return 204 No Content

    5. **POST /api/fingerprint/drift/baseline** - Establish baseline manually:
       ```python
       @router.post("/drift/baseline")
       async def establish_drift_baseline(
           similarities: List[float],
           current_user: User = Depends(get_current_user),
           db: Session = Depends(get_db)
       ):
           """
           Manually establish drift baseline from similarity scores.
           Useful for initializing baseline after corpus creation.
           """
       ```
       - Validate 3 <= len(similarities) <= 100
       - Create/retrieve StyleDriftDetector for user
       - Call detector.establish_baseline(similarities)
       - Store detector state (pickle or separate table) for persistence
       - Return {"status": "baseline_established", "mean": float, "std": float}

    Use @general_rate_limit on POST endpoints
  </action>
  <verify>
    Run: python -c "from app.api.routes.fingerprint import router; drift_routes = [p.path for p in router.routes if 'drift' in p.path]; print(drift_routes)"
    Should include: /drift/alerts, /drift/check, /drift/acknowledge/{alert_id}, /drift/baseline
  </verify>
  <done>
    All drift endpoints registered, request/response schemas match
  </done>
</task>

<task type="auto">
  <name>Task 2: Add drift detection to FingerprintService</name>
  <files>backend/app/services/fingerprint_service.py</files>
  <action>
    Extend FingerprintService in backend/app/services/fingerprint_service.py:

    1. **get_drift_detector(self, db, user_id)** - Get or create detector for user:
       - Check if detector exists in cache (simple dict cache or store in database as JSON)
       - If not exists: create new StyleDriftDetector with default thresholds
       - Load baseline from DriftAlert history or user settings if available
       - Return detector instance

    2. **check_drift_and_create_alert(self, db, user_id, text)**:
       - Get user's EnhancedFingerprint
       - Get drift detector for user
       - Compare text to fingerprint: similarity + feature_deviations
       - Check drift: result = detector.check_drift(similarity, feature_deviations)
       - If result["drift_detected"]:
         * Create DriftAlert record with all fields
         * Return alert object
       - Else: return None

    3. **get_drift_alerts(self, db, user_id, include_acknowledged=False)**:
       - Query DriftAlert for user
       - Filter by acknowledged if specified
       - Order by created_at DESC
       - Return list of DriftAlertResponse

    4. **acknowledge_alert(self, db, user_id, alert_id, update_baseline=False)**:
       - Validate alert belongs to user
       - Set acknowledged = True
       - If update_baseline: recalculate from recent alerts
       - Return True

    Import: from app.models.database import DriftAlert
    Import: from app.ml.fingerprint.drift_detector import StyleDriftDetector
    Import: from app.ml.fingerprint.similarity_calculator import FingerprintComparator
  </action>
  <verify>
    Run: python -c "from app.services.fingerprint_service import get_fingerprint_service; fs = get_fingerprint_service(); print([m for m in dir(fs) if 'drift' in m.lower()])"
    Should include: get_drift_detector, check_drift_and_create_alert, get_drift_alerts, acknowledge_alert
  </verify>
  <done>
    Service methods integrate with StyleDriftDetector, handle alert persistence
  </done>
</task>

<task type="auto">
  <name>Task 3: Add drift API methods to frontend</name>
  <files>frontend/src/services/api.ts</files>
  <action>
    Extend api.ts with driftAPI object:

    ```typescript
    export const driftAPI = {
      // Get drift alerts for current user
      getAlerts: async (includeAcknowledged = false) => {
        const response = await fetchWithAuth(`/api/fingerprint/drift/alerts?include_acknowledged=${includeAcknowledged}`);
        return response;
      },

      // Check text for style drift
      checkDrift: async (text: string) => {
        const response = await fetchWithAuth('/api/fingerprint/drift/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, use_enhanced: true }),
        });
        return response;
      },

      // Acknowledge an alert
      acknowledgeAlert: async (alertId: number, updateBaseline = false) => {
        await fetchWithAuth(`/api/fingerprint/drift/acknowledge/${alertId}?update_baseline=${updateBaseline}`, {
          method: 'POST',
        });
      },

      // Establish baseline manually
      establishBaseline: async (similarities: number[]) => {
        const response = await fetchWithAuth('/api/fingerprint/drift/baseline', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ similarities }),
        });
        return response;
      },
    };
    ```

    Add TypeScript interfaces:
    ```typescript
    interface DriftSeverity extends UnionEnum {
      WARNING: 'warning';
      ALERT: 'alert';
      NONE: 'none';
    }

    interface FeatureChange {
      feature: string;
      current_value: number;
      baseline_value: number;
      normalized_deviation: number;
    }

    interface DriftDetectionResult {
      drift_detected: boolean;
      severity: DriftSeverity;
      similarity: number;
      baseline_mean: number;
      z_score: number;
      confidence_interval: [number, number];
      changed_features: FeatureChange[];
      timestamp?: string;
    }

    interface DriftAlert {
      id: number;
      severity: DriftSeverity;
      similarity_score: number;
      baseline_similarity: number;
      z_score: number;
      changed_features: FeatureChange[];
      text_preview?: string;
      acknowledged: boolean;
      created_at: string;
    }
    ```
  </action>
  <verify>
    Run: grep -E "driftAPI\.(getAlerts|checkDrift|acknowledgeAlert)" frontend/src/services/api.ts
    Verify: All three methods defined
  </verify>
  <done>
    driftAPI object exported with all methods, TypeScript interfaces defined
  </done>
</task>

<task type="auto">
  <name>Task 4: Create DriftAlerts React component</name>
  <files>frontend/src/components/ProfileManager/DriftAlerts.tsx</files>
  <action>
    Create frontend/src/components/ProfileManager/DriftAlerts.tsx:

    1. **Component structure**:
       - Header: "Style Drift Alerts" with unacknowledged count badge
       - Filter toggle: "Show Acknowledged" checkbox
       - Alert list: Cards for each alert, grouped by severity
       - Empty state: "No drift alerts detected" when list empty

    2. **Alert card display**:
       - Severity badge: "ALERT" (red) or "WARNING" (yellow)
       - Similarity score: "65% similarity vs baseline 82%"
       - Z-score: "2.3 standard deviations from baseline"
       - Confidence interval visualization: Bar showing current vs [lower, upper] range
       - Changed features: Table showing top 5 features with deviations
       - Text preview: "Triggered by: [first 200 chars of text]"
       - Created date: Relative time (e.g., "2 hours ago")
       - Acknowledge button: "Acknowledge" with checkbox for "Update baseline"

    3. **Changed features table**:
       - Columns: Feature, Baseline Value, Current Value, Deviation
       - Color-code deviation: red if >3.0, yellow if >2.0
       - Show feature names in human-readable format (from FEATURE_NAMES mapping)

    4. **State**:
       - alerts: DriftAlert[]
       - loading: boolean
       - showAcknowledged: boolean
       - acknowledging: Set<alertId>

    5. **Actions**:
       - loadAlerts() on mount and when showAcknowledged changes
       - handleAcknowledge(alertId, updateBaseline) calls driftAPI.acknowledgeAlert()
       - Refresh list after acknowledgment

    Use existing components: Card, Badge, Button, Alert, Checkbox (or custom toggle)
    Use icons: AlertTriangle, Warning, CheckCircle, Clock from lucide-react
    Apply consistent styling with dark mode support
  </action>
  <verify>
    Run: grep -E "(driftAPI|DriftAlert|severity)" frontend/src/components/ProfileManager/DriftAlerts.tsx | wc -l
    Should find >15 matches
  </verify>
  <done>
    Component displays drift alerts, shows severity and feature changes, acknowledge works
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate DriftAlerts into ProfileManager</name>
  <files>frontend/src/components/ProfileManager/ProfileManager.tsx</files>
  <action>
    Update frontend/src/components/ProfileManager/ProfileManager.tsx:

    1. Add import: import DriftAlerts from './DriftAlerts';

    2. Add new tab after "Fingerprint Profile":
       ```tsx
       <TabsTrigger value="drift">
         Drift Alerts
         {unacknowledgedCount > 0 && (
           <Badge variant="danger" size="sm" className="ml-2">
             {unacknowledgedCount}
           </Badge>
         )}
       </TabsTrigger>
       ```

    3. Add state for unacknowledged count:
       ```tsx
       const [unacknowledgedCount, setUnacknowledgedCount] = useState(0);
       ```

    4. Add useEffect to load unacknowledged count:
       ```tsx
       useEffect(() => {
         const loadUnacknowledgedCount = async () => {
           try {
             const data = await driftAPI.getAlerts(false);
             setUnacknowledgedCount(data.unacknowledged_count || 0);
           } catch (err) {
             console.error('Error loading drift alert count:', err);
           }
         };
         loadUnacknowledgedCount();
       }, []);
       ```

    5. Add corresponding TabsContent:
       ```tsx
       <TabsContent value="drift">
         <DriftAlerts onAlertAcknowledged={() => setUnacknowledgedCount(c => Math.max(0, c - 1))} />
       </TabsContent>
       ```

    6. Import driftAPI in ProfileManager if not already available

    This adds a visual indicator on the tab when unacknowledged alerts exist.
  </action>
  <verify>
    Run: grep -E "(DriftAlerts|drift|unacknowledged)" frontend/src/components/ProfileManager/ProfileManager.tsx
    Verify: DriftAlerts imported and integrated, badge shows count
  </verify>
  <done>
    ProfileManager shows Drift Alerts tab with unacknowledged count badge
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete drift detection system with API endpoints, service methods, frontend API integration, and React UI component</what-built>
  <how-to-verify>
    1. Navigate to Profile -> Drift Alerts tab
    2. Verify empty state shows when no alerts exist
    3. Create a drift alert scenario:
       - Go to Fingerprint Profile tab
       - Paste text that is VERY different from your fingerprint (e.g., AI-generated text)
       - Use browser DevTools or direct API call to POST /api/fingerprint/drift/check with this text
    4. Return to Drift Alerts tab
    5. Verify alert appears with:
       - Severity badge (WARNING or ALERT)
       - Similarity score vs baseline
       - Z-score display
       - Confidence interval visualization
       - Changed features table
    6. Click "Acknowledge" button
    7. Verify alert disappears from unacknowledged list
    8. Toggle "Show Acknowledged" - verify alert still visible in acknowledged list
  </how-to-verify>
  <resume-signal>Type "approved" if drift detection works as expected, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. API endpoints work:
   - GET /drift/alerts returns list with unacknowledged_count
   - POST /drift/check with AI-generated text creates alert
   - POST /drift/acknowledge/{id} sets acknowledged=true
2. Frontend displays alerts correctly:
   - Navigate to Profile -> Drift Alerts
   - See alert cards with severity badges
   - Changed features table shows feature deviations
3. Acknowledgment flow works:
   - Click acknowledge -> alert removed from unacknowledged
   - Badge count decreases
</verification>

<success_criteria>
- Drift alerts created when similarity deviates >2.0 std from baseline
- Alert severity classified correctly (warning >=2.0, alert >=3.0)
- Alerts include z-score, confidence interval, and changed features
- User can acknowledge alerts with optional baseline update
- UI shows unacknowledged count badge on tab
- Changed features highlight which stylometric features deviated most
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-fingerprinting/05-06-SUMMARY.md` with:
- Z-score threshold values and observed alert rates
- False positive observations (if any)
- User feedback on alert usefulness
- Baseline update behavior
- Performance notes for drift detection queries
</output>
