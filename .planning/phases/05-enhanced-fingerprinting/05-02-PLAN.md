---
phase: 05-enhanced-fingerprinting
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - backend/app/ml/fingerprint/time_weighted_trainer.py
  - backend/app/ml/fingerprint/similarity_calculator.py
  - backend/app/ml/fingerprint/__init__.py
  - backend/app/api/routes/fingerprint.py
  - backend/app/services/fingerprint_service.py
  - backend/app/models/schemas.py
  - frontend/src/components/ProfileManager/FingerprintProfile.tsx
autonomous: true

must_haves:
  truths:
    - "System applies exponential moving average (EMA) with alpha=0.3 for time-weighted training"
    - "Recent writing samples receive higher weight in fingerprint calculation"
    - "Fingerprint includes per-feature statistics (mean, variance) for confidence intervals"
    - "User can compare text to fingerprint with similarity score and confidence interval"
    - "Cosine similarity threshold of 0.70 used for 'likely match' classification"
  artifacts:
    - path: "backend/app/ml/fingerprint/time_weighted_trainer.py"
      provides: "TimeWeightedFingerprintBuilder class with EMA-based training"
      exports: ["TimeWeightedFingerprintBuilder", "add_sample", "get_fingerprint", "compute_recency_weights"]
      contains: "class TimeWeightedFingerprintBuilder"
    - path: "backend/app/ml/fingerprint/similarity_calculator.py"
      provides: "FingerprintComparator for similarity with confidence intervals"
      exports: ["FingerprintComparator", "compare_with_confidence", "THRESHOLD_HIGH_SIMILARITY"]
      contains: "class FingerprintComparator"
    - path: "backend/app/api/routes/fingerprint.py"
      provides: "Comparison endpoint POST /api/fingerprint/compare"
      exports: ["compare_text_to_fingerprint"]
    - path: "frontend/src/components/ProfileManager/FingerprintProfile.tsx"
      provides: "Visual fingerprint representation with similarity checker"
      min_lines: 150
  key_links:
    - from: "backend/app/ml/fingerprint/time_weighted_trainer.py"
      to: "numpy"
      via: "np.array for vector operations, exponential decay calculation"
      pattern: "np\\.exp\\(-decay_rate \\* ages\\)"
    - from: "backend/app/ml/fingerprint/similarity_calculator.py"
      to: "sklearn.metrics.pairwise.cosine_similarity"
      via: "cosine_similarity import for similarity calculation"
      pattern: "cosine_similarity\\("
    - from: "backend/app/api/routes/fingerprint.py"
      to: "FingerprintComparator"
      via: "compare_with_confidence method call"
      pattern: "compare_with_confidence\\("
---

<objective>
Implement time-weighted fingerprint training using exponential moving average (EMA) to account for natural style evolution, and similarity calculation with confidence intervals.

Purpose: Writing style evolves over time. Equal-weighted averaging treats all historical samples equally, causing fingerprints to become outdated. EMA gives recent samples higher weight while maintaining historical patterns. Confidence intervals quantify uncertainty in similarity scores.

Output: TimeWeightedFingerprintBuilder module, FingerprintComparator with confidence intervals, comparison API endpoint, and visual fingerprint profile component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enhanced-fingerprinting/05-enhanced-fingerprinting-RESEARCH.md

@.planning/phases/05-enhanced-fingerprinting/05-01-PLAN.md
@backend/app/ml/fingerprint/corpus_builder.py
@backend/app/ml/fingerprint.py
@backend/app/ml/feature_extraction.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement TimeWeightedFingerprintBuilder with EMA</name>
  <files>backend/app/ml/fingerprint/time_weighted_trainer.py</files>
  <action>
    Create backend/app/ml/fingerprint/time_weighted_trainer.py with:

    1. **TimeWeightedFingerprintBuilder** class:
       ```python
       class TimeWeightedFingerprintBuilder:
           MIN_SAMPLES_FOR_FINGERPRINT = 10

           def __init__(self, alpha: float = 0.3):
               """
               Args:
                   alpha: EMA smoothing factor (0-1). Higher = more weight to recent samples.
                          0.3 is standard for balanced recency.
               """
               self.alpha = alpha
               self.fingerprint_vector = None
               self.sample_count = 0
               self.feature_stats = {}  # Track per-feature statistics for CI
       ```

    2. **add_sample(self, features: np.ndarray, timestamp: datetime = None) -> None**:
       - If first sample: initialize fingerprint_vector = features.copy(), sample_count = 1
       - Otherwise: apply EMA update
         ```python
         self.fingerprint_vector = (
             (1 - self.alpha) * self.fingerprint_vector +
             self.alpha * features
         )
         self.sample_count += 1
         ```
       - Call _update_stats(features) to track per-feature mean/variance using Welford's algorithm

    3. **compute_recency_weights(self, timestamps: List[datetime], current_time: datetime) -> np.ndarray**:
       - Calculate age in days for each timestamp
       - Compute exponential decay weights: weight = e^(-lambda * age)
       - Lambda = -ln(alpha) for consistency with EMA
       - Normalize weights to sum to 1.0

    4. **get_fingerprint(self) -> Dict**:
       - Returns dictionary with:
         * feature_vector: list of floats
         * sample_count: int
         * model_version: "2.0"
         * method: "time_weighted_ema"
         * alpha: float
         * feature_statistics: dict from _get_feature_stats_summary()

    5. **_update_stats(self, features: np.ndarray) -> None**: Welford's online algorithm for variance
       ```python
       for i, val in enumerate(features):
           if i not in self.feature_stats:
               self.feature_stats[i] = {"mean": val, "variance": 0.0, "count": 1}
           else:
               stats = self.feature_stats[i]
               stats["count"] += 1
               delta = val - stats["mean"]
               stats["mean"] += delta / stats["count"]
               stats["variance"] += delta * (val - stats["mean"])
       ```

    6. **_get_feature_stats_summary(self) -> Dict**: Convert feature_stats to serializable format

    Imports: numpy as np, datetime from datetime, typing (List, Dict, Optional)
  </action>
  <verify>
    Run: python -c "from app.ml.fingerprint.time_weighted_trainer import TimeWeightedFingerprintBuilder; builder = TimeWeightedFingerprintBuilder(); print(f'alpha: {builder.alpha}')"
    Output: alpha: 0.3
  </verify>
  <done>
    Class initializes correctly, EMA formula implemented, Welford's algorithm tracks feature statistics
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement FingerprintComparator with confidence intervals</name>
  <files>backend/app/ml/fingerprint/similarity_calculator.py</files>
  <action>
    Create backend/app/ml/fingerprint/similarity_calculator.py with:

    1. **FingerprintComparator** class with class constants:
       ```python
       class FingerprintComparator:
           # Cosine similarity thresholds from authorship verification research
           THRESHOLD_HIGH_SIMILARITY = 0.85  # Strong match
           THRESHOLD_MEDIUM_SIMILARITY = 0.70  # Likely match
           THRESHOLD_LOW_SIMILARITY = 0.50  # Ambiguous/below threshold
       ```

    2. **__init__(self, confidence_level: float = 0.95)**:
       - Store confidence_level
       - Calculate z_score using scipy.stats.norm.ppf: self.z_score = stats.norm.ppf((1 + confidence_level) / 2)

    3. **compare_with_confidence(self, text_features: np.ndarray, fingerprint: Dict, fingerprint_stats: Dict = None) -> Dict**:
       - Extract fp_vector = np.array(fingerprint["feature_vector"])
       - Compute cosine similarity using sklearn.metrics.pairwise.cosine_similarity
       - Calculate CI width via _calculate_ci_width()
       - Compute feature deviations via _compute_feature_deviations()
       - Return dict with:
         * similarity: float (0-1)
         * confidence_interval: [lower, upper]
         * match_level: "HIGH" | "MEDIUM" | "LOW"
         * feature_deviations: dict of top 5 differing features

    4. **_calculate_ci_width(self, text_features, fp_vector, stats) -> float**:
       - If no stats: return 0.1 (default)
       - Extract variances from stats for each feature
       - Calculate SEM = sqrt(mean(variance) / n_features)
       - Return z_score * SEM

    5. **_classify_match(self, similarity: float) -> str**:
       - >= THRESHOLD_HIGH_SIMILARITY: return "HIGH"
       - >= THRESHOLD_MEDIUM_SIMILARITY: return "MEDIUM"
       - else: return "LOW"

    6. **_compute_feature_deviations(self, text_features, fp_vector, stats) -> Dict**:
       - For each feature, calculate absolute deviation
       - Normalize by sqrt(variance) if stats available
       - Return top 5 features by normalized deviation > 2.0
       - Format: {"feature_name": {"text_value": float, "fingerprint_value": float, "deviation": float}}

    Imports: numpy as np, scipy.stats, sklearn.metrics.pairwise.cosine_similarity
    Import FEATURE_NAMES from app.ml.feature_extraction
  </action>
  <verify>
    Run: python -c "from app.ml.fingerprint.similarity_calculator import FingerprintComparator; c = FingerprintComparator(); print(f'HIGH threshold: {c.THRESHOLD_HIGH_SIMILARITY}')"
    Output: HIGH threshold: 0.85
  </verify>
  <done>
    Comparator calculates cosine similarity, computes confidence intervals, classifies match level
  </done>
</task>

<task type="auto">
  <name>Task 3: Update fingerprint module exports</name>
  <files>backend/app/ml/fingerprint/__init__.py</files>
  <action>
    Create backend/app/ml/fingerprint/__init__.py with exports:

    ```python
    """
    Enhanced fingerprinting modules for corpus-based, time-weighted fingerprint generation.
    """
    from .corpus_builder import FingerprintCorpusBuilder
    from .time_weighted_trainer import TimeWeightedFingerprintBuilder
    from .similarity_calculator import FingerprintComparator

    # Legacy functions (for backward compatibility)
    from ..fingerprint import generate_fingerprint, update_fingerprint, compare_to_fingerprint

    __all__ = [
        "FingerprintCorpusBuilder",
        "TimeWeightedFingerprintBuilder",
        "FingerprintComparator",
        "generate_fingerprint",
        "update_fingerprint",
        "compare_to_fingerprint",
    ]
    ```

    This allows both new enhanced API and legacy single-sample API.
  </action>
  <verify>
    Run: python -c "from app.ml.fingerprint import FingerprintCorpusBuilder, TimeWeightedFingerprintBuilder, FingerprintComparator; print('Exports successful')"
  </verify>
  <done>
    All fingerprint modules can be imported from app.ml.fingerprint namespace
  </done>
</task>

<task type="auto">
  <name>Task 4: Add comparison API endpoint</name>
  <files>backend/app/api/routes/fingerprint.py</files>
  <action>
    Add to backend/app/api/routes/fingerprint.py:

    1. **Add new schema to imports**:
       - from app.models.schemas import FingerprintComparisonRequest, FingerprintComparisonResponse

    2. **Add schemas to schemas.py first** (separate task):
       - FingerprintComparisonRequest: text: str, use_enhanced: bool = True
       - FingerprintComparisonResponse: similarity, confidence_interval, match_level, feature_deviations, method_used

    3. **POST /api/fingerprint/compare** endpoint:
       ```python
       @router.post("/compare", response_model=FingerprintComparisonResponse)
       async def compare_text_to_fingerprint(
           request: FingerprintComparisonRequest,
           current_user: User = Depends(get_current_user),
           db: Session = Depends(get_db)
       ):
           """
           Compare text to user's fingerprint with confidence intervals.

           Returns similarity score, confidence interval, match level,
           and which features differ most.
           """
       ```
       - Get user's EnhancedFingerprint if use_enhanced=True, else basic Fingerprint
       - If no fingerprint: raise 404 with helpful message
       - Extract features from text using extract_feature_vector
       - Use FingerprintComparator to compare
       - Return FingerprintComparisonResponse

    4. **GET /api/fingerprint/profile** endpoint (optional but useful):
       - Returns user's enhanced fingerprint with metadata
       - Includes: corpus_size, method, alpha, source_distribution, date_range

    Import: from app.ml.fingerprint.similarity_calculator import FingerprintComparator
    Import: from app.ml.feature_extraction import extract_feature_vector
  </action>
  <verify>
    Run: python -c "from app.api.routes.fingerprint import router; routes = [p.path for p in router.routes if 'compare' in p.path]; print(routes)"
    Output should include: /api/fingerprint/compare
  </verify>
  <done>
    POST /compare endpoint accepts text, returns similarity with confidence interval
  </done>
</task>

<task type="auto">
  <name>Task 5: Add comparison schemas</name>
  <files>backend/app/models/schemas.py</files>
  <action>
    Add to backend/app/models/schemas.py (after FingerprintStatus, before Analysis Schemas):

    1. **FingerprintComparisonRequest**:
       ```python
       class FingerprintComparisonRequest(BaseModel):
           text: str = Field(..., min_length=10)
           use_enhanced: bool = Field(default=True, description="Use enhanced fingerprint if available")
       ```

    2. **FeatureDeviation** (nested model):
       ```python
       class FeatureDeviation(BaseModel):
           feature: str
           text_value: float
           fingerprint_value: float
           deviation: float
       ```

    3. **ConfidenceInterval**:
       ```python
       class ConfidenceInterval(BaseModel):
           lower: float
           upper: float
       ```

    4. **FingerprintComparisonResponse**:
       ```python
       class FingerprintComparisonResponse(BaseModel):
           similarity: float = Field(..., ge=0.0, le=1.0)
           confidence_interval: ConfidenceInterval
           match_level: str = Field(..., pattern="^(HIGH|MEDIUM|LOW)$")
           feature_deviations: List[FeatureDeviation]
           method_used: str  # "time_weighted_ema", "average", or "basic"
           corpus_size: Optional[int] = None
       ```

    These schemas enable type-safe API requests/responses for fingerprint comparison.
  </action>
  <verify>
    Run: python -c "from app.models.schemas import FingerprintComparisonRequest, FingerprintComparisonResponse; print('Schemas imported')"
  </verify>
  <done>
    Schemas validate correctly, match_level pattern enforced
  </done>
</task>

<task type="auto">
  <name>Task 6: Add comparison methods to FingerprintService</name>
  <files>backend/app/services/fingerprint_service.py</files>
  <action>
    Extend FingerprintService in backend/app/services/fingerprint_service.py:

    1. **compare_text_to_fingerprint(self, db, user_id, text, use_enhanced=True)**:
       - If use_enhanced: query EnhancedFingerprint first, fall back to basic Fingerprint
       - If no fingerprint exists: raise ValueError("No fingerprint found")
       - Extract features from text: extract_feature_vector(text)
       - Initialize FingerprintComparator with confidence_level=0.95
       - Get feature_statistics from enhanced fingerprint if available
       - Call comparator.compare_with_confidence(text_features, fingerprint_dict, stats)
       - Return dict matching FingerprintComparisonResponse schema

    2. **get_fingerprint_profile(self, db, user_id)**:
       - Query EnhancedFingerprint for user
       - If not found, fall back to basic Fingerprint
       - Return dict with: feature_vector, corpus_size, method, alpha, source_distribution, created_at, updated_at

    Import: from app.ml.fingerprint.similarity_calculator import FingerprintComparator
    Import: from app.ml.feature_extraction import extract_feature_vector
    Import: from app.models.database import EnhancedFingerprint
  </action>
  <verify>
    Run: python -c "from app.services.fingerprint_service import get_fingerprint_service; fs = get_fingerprint_service(); print(hasattr(fs, 'compare_text_to_fingerprint'))"
    Output: True
  </verify>
  <done>
    Service methods integrate with FingerprintComparator, handle enhanced/basic fallback
  </done>
</task>

<task type="auto">
  <name>Task 7: Add comparison API to frontend</name>
  <files>frontend/src/services/api.ts</files>
  <action>
    Extend fingerprintAPI in frontend/src/services/api.ts:

    1. **compare(text: string, useEnhanced: boolean = true)**:
       - POST to /api/fingerprint/compare
       - Body: { text, use_enhanced: useEnhanced }
       - Returns: FingerprintComparisonResponse

    2. **getProfile()**:
       - GET from /api/fingerprint/profile
       - Returns: Enhanced fingerprint profile with metadata

    Add TypeScript interfaces for these responses:
    ```typescript
    interface ConfidenceInterval {
      lower: number;
      upper: number;
    }

    interface FeatureDeviation {
      feature: string;
      text_value: number;
      fingerprint_value: number;
      deviation: number;
    }

    interface FingerprintComparisonResponse {
      similarity: number;
      confidence_interval: ConfidenceInterval;
      match_level: 'HIGH' | 'MEDIUM' | 'LOW';
      feature_deviations: FeatureDeviation[];
      method_used: string;
      corpus_size?: number;
    }

    interface FingerprintProfile {
      corpus_size: number;
      method: string;
      alpha: number;
      source_distribution: Record<string, number>;
      created_at: string;
      updated_at: string;
    }
    ```
  </action>
  <verify>
    Run: grep "compare(" frontend/src/services/api.ts
    Verify: fingerprintAPI.compare method exists
  </verify>
  <done>
    Frontend API methods defined with proper TypeScript types
  </done>
</task>

<task type="auto">
  <name>Task 8: Create FingerprintProfile visual component</name>
  <files>frontend/src/components/ProfileManager/FingerprintProfile.tsx</files>
  <action>
    Create frontend/src/components/ProfileManager/FingerprintProfile.tsx:

    1. **Component features**:
       - Display fingerprint metadata: corpus_size, method, alpha, created_at, updated_at
       - Visual representation of 27-feature vector as a radar-like chart or bar chart
       - Source distribution visualization (pie or bar chart)
       - Similarity checker: paste text to compare against fingerprint

    2. **Similarity checker section**:
       - Textarea for input text
       - "Check Similarity" button
       - Results display:
         * Similarity score (0-100%) with color coding (green >0.85, yellow >0.70, red <0.70)
         * Confidence interval: "X% to Y%" range
         * Match level badge (HIGH/MEDIUM/LOW)
         * Feature deviations table: top 5 differing features with text vs fingerprint values

    3. **State**:
       - profile: FingerprintProfile | null
       - comparisonText: string
       - comparisonResult: FingerprintComparisonResponse | null
       - loading: boolean

    4. **Actions**:
       - loadProfile() on mount
       - checkSimilarity() calls fingerprintAPI.compare()
       - Display error if no fingerprint exists

    Use existing UI components: Card, Button, Badge, Alert, Textarea, ProgressBar
    Use icons: Fingerprint, Target, Sparkles from lucide-react
    Apply consistent dark mode styling
  </action>
  <verify>
    Run: grep -E "(FingerprintProfile|similarity|comparison)" frontend/src/components/ProfileManager/FingerprintProfile.tsx | wc -l
    Should find >15 matches
  </verify>
  <done>
    Component displays fingerprint profile, similarity checker works with text input
  </done>
</task>

<task type="auto">
  <name>Task 9: Integrate FingerprintProfile into ProfileManager</name>
  <files>frontend/src/components/ProfileManager/ProfileManager.tsx</files>
  <action>
    Update frontend/src/components/ProfileManager/ProfileManager.tsx:

    1. Add import: import FingerprintProfile from './FingerprintProfile';

    2. Add new tab after "Enhanced Corpus":
       ```tsx
       <TabsTrigger value="profile">Fingerprint Profile</TabsTrigger>
       ```

    3. Add corresponding TabsContent:
       ```tsx
       <TabsContent value="profile">
         <FingerprintProfile />
       </TabsContent>
       ```

    4. Update tab order if needed to show logical flow:
       - Upload File / Paste Text (existing)
       - Enhanced Corpus (05-01)
       - Fingerprint Profile (this task)
       - Fine-tune (existing, shown only when has_fingerprint)

    The Profile tab should be accessible only when user has a fingerprint (basic or enhanced).
    Add conditional: {status?.has_fingerprint && <TabsTrigger value="profile">Fingerprint Profile</TabsTrigger>}
  </action>
  <verify>
    Run: grep "FingerprintProfile" frontend/src/components/ProfileManager/ProfileManager.tsx
    Verify: Component imported and used in tabs
  </verify>
  <done>
    ProfileManager shows Fingerprint Profile tab when user has fingerprint
  </done>
</task>

</tasks>

<verification>
1. TimeWeightedFingerprintBuilder applies EMA correctly:
   - Test with 3 samples, verify recency weights increase for recent timestamps
2. FingerprintComparator returns correct similarity scores:
   - Test with identical text -> similarity >0.95
   - Test with very different text -> similarity <0.50
3. API endpoints work:
   - POST /api/fingerprint/compare with text returns 200 with similarity score
   - Response includes confidence_interval and feature_deviations
4. Frontend displays comparison results:
   - Navigate to Profile -> Fingerprint Profile tab
   - Paste text, click "Check Similarity"
   - See similarity %, confidence interval, match level badge
5. Match levels align with thresholds:
   - Similarity >0.85 shows "HIGH" badge (green)
   - Similarity 0.70-0.85 shows "MEDIUM" badge (yellow)
   - Similarity <0.70 shows "LOW" badge (red)
</verification>

<success_criteria>
- Time-weighted training uses EMA with alpha=0.3, giving recent samples higher weight
- Fingerprint comparison returns similarity score with 95% confidence interval
- Match level classification uses thresholds: HIGH >=0.85, MEDIUM >=0.70, LOW <0.70
- Feature deviations highlight which stylometric features differ most
- User can interactively compare text to their fingerprint via UI
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-fingerprinting/05-02-SUMMARY.md` with:
- EMA alpha value and recency calculation details
- Similarity threshold values and match level behavior
- Confidence interval calculation method (z-score, SEM)
- Any deviations from research recommendations
- Performance notes for similarity calculations
</output>
