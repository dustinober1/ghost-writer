---
phase: 05-enhanced-fingerprinting
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - backend/app/api/routes/fingerprint.py
  - backend/app/services/fingerprint_service.py
  - frontend/src/services/api.ts
  - frontend/src/components/ProfileManager/CorpusBuilder.tsx
  - frontend/src/components/ProfileManager/ProfileManager.tsx
autonomous: true

must_haves:
  truths:
    - "User can upload multiple writing samples (10+) to build a corpus"
    - "User can view corpus summary showing sample count and distribution by source type"
    - "System validates minimum 10 samples before allowing enhanced fingerprint generation"
    - "User can delete individual samples from corpus"
    - "Corpus builder UI accessible from ProfileManager Enhanced Corpus tab"
  artifacts:
    - path: "backend/app/api/routes/fingerprint.py"
      provides: "Corpus management endpoints (POST /corpus/add, GET /corpus/status, DELETE /corpus/sample/{id})"
      exports: ["add_corpus_sample", "get_corpus_status", "delete_corpus_sample"]
    - path: "backend/app/services/fingerprint_service.py"
      provides: "Service methods for corpus operations"
      exports: ["add_corpus_sample", "get_corpus_status", "generate_enhanced_fingerprint"]
    - path: "frontend/src/services/api.ts"
      provides: "Frontend corpus API methods"
      exports: ["corpus.add", "corpus.getStatus", "corpus.deleteSample"]
    - path: "frontend/src/components/ProfileManager/CorpusBuilder.tsx"
      provides: "UI for managing writing samples with bulk upload and sample list"
      min_lines: 200
  key_links:
    - from: "backend/app/api/routes/fingerprint.py"
      to: "FingerprintSample database table"
      via: "SQLAlchemy ORM query"
      pattern: "FingerprintSample.*user_id"
    - from: "frontend/src/components/ProfileManager/CorpusBuilder.tsx"
      to: "/api/fingerprint/corpus/*"
      via: "fingerprintAPI corpus methods in api.ts"
      pattern: "fingerprintAPI.corpus"
---

<objective>
Build corpus management API and frontend UI for multi-sample fingerprint generation.

Purpose: Users need a way to add, view, and delete writing samples to build their corpus. The API provides CRUD operations for samples and fingerprint generation. The UI displays corpus status, manages samples, and triggers enhanced fingerprint generation when 10+ samples are ready.

Output: Corpus API endpoints, FingerprintService methods, frontend API integration, and CorpusBuilder React component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enhanced-fingerprinting/05-enhanced-fingerprinting-RESEARCH.md

@.planning/phases/05-enhanced-fingerprinting/05-01-PLAN.md
@backend/app/ml/fingerprint/corpus_builder.py
@backend/app/api/routes/fingerprint.py
@backend/app/services/fingerprint_service.py
@frontend/src/services/api.ts
@frontend/src/components/ProfileManager/ProfileManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add corpus management API endpoints</name>
  <files>backend/app/api/routes/fingerprint.py</files>
  <action>
    Extend existing backend/app/api/routes/fingerprint.py with new endpoints:

    1. **POST /api/fingerprint/corpus/add** - Add sample to corpus:
       - Accepts: FingerprintSampleCreate (text_content, source_type, written_at)
       - Validates text length (min 10 chars)
       - Extracts features using extract_feature_vector
       - Creates FingerprintSample record with features JSON, word_count
       - Returns: FingerprintSampleResponse
       - Apply @general_rate_limit decorator

    2. **GET /api/fingerprint/corpus/status** - Get corpus summary:
       - Queries user's FingerprintSample records
       - Computes: sample_count, total_words, source_distribution, ready_for_fingerprint
       - Returns: CorpusStatus with samples_needed = max(0, 10 - sample_count)
       - Include oldest_sample and newest_sample timestamps

    3. **GET /api/fingerprint/corpus/samples** - List all samples (paginated):
       - Query params: page=1, page_size=20
       - Returns List[FingerprintSampleResponse]
       - Order by created_at DESC

    4. **DELETE /api/fingerprint/corpus/sample/{sample_id}** - Delete sample:
       - Validates sample belongs to current_user
       - Deletes sample, returns 204 No Content

    5. **POST /api/fingerprint/corpus/generate** - Generate enhanced fingerprint:
       - Validates corpus_size >= 10
       - Uses FingerprintCorpusBuilder to build fingerprint
       - Creates/updates EnhancedFingerprint record
       - Returns: EnhancedFingerprintResponse

    Import new schemas: FingerprintSampleCreate, FingerprintSampleResponse, CorpusStatus, EnhancedFingerprintResponse
    Import database models: FingerprintSample, EnhancedFingerprint
    Import FingerprintCorpusBuilder: from app.ml.fingerprint.corpus_builder import FingerprintCorpusBuilder
  </action>
  <verify>
    Run: python -c "from app.api.routes.fingerprint import router; print(f'Fingerprint routes: {[p.path for p in router.routes]}')"
    Verify new routes exist: /corpus/add, /corpus/status, /corpus/samples, /corpus/sample/{sample_id}, /corpus/generate
  </verify>
  <done>
    All endpoints registered, route paths correct, request/response schemas defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Update FingerprintService for corpus operations</name>
  <files>backend/app/services/fingerprint_service.py</files>
  <action>
    Extend FingerprintService class in backend/app/services/fingerprint_service.py with new methods:

    1. **add_corpus_sample(self, db, user_id, text_content, source_type="manual", written_at=None)**:
       - Extract features using extract_feature_vector
       - Create FingerprintSample record with features JSON
       - Return FingerprintSample object

    2. **get_corpus_status(self, db, user_id)**:
       - Query all FingerprintSample for user
       - Calculate sample_count, total_words, source_distribution
       - Compute ready_for_fingerprint = sample_count >= 10
       - Return dict matching CorpusStatus schema

    3. **list_corpus_samples(self, db, user_id, page=1, page_size=20)**:
       - Query FingerprintSample with pagination
       - Order by created_at DESC
       - Return list of FingerprintSampleResponse

    4. **delete_corpus_sample(self, db, user_id, sample_id)**:
       - Validate sample belongs to user
       - Delete sample
       - Return True if deleted

    5. **generate_enhanced_fingerprint(self, db, user_id, method="time_weighted", alpha=0.3)**:
       - Get all FingerprintSample for user
       - Use FingerprintCorpusBuilder to build fingerprint
       - Create/update EnhancedFingerprint record
       - Return EnhancedFingerprint object

    Add imports: from app.models.database import FingerprintSample, EnhancedFingerprint
    Import: from app.ml.fingerprint.corpus_builder import FingerprintCorpusBuilder
  </action>
  <verify>
    Run: python -c "from app.services.fingerprint_service import get_fingerprint_service; fs = get_fingerprint_service(); print([m for m in dir(fs) if not m.startswith('_')])"
    Verify new methods exist: add_corpus_sample, get_corpus_status, generate_enhanced_fingerprint
  </verify>
  <done>
    Service methods defined, integrate with FingerprintCorpusBuilder correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Add corpus API methods to frontend</name>
  <files>frontend/src/services/api.ts</files>
  <action>
    Extend fingerprintAPI object in frontend/src/services/api.ts with new methods:

    1. **corpus.add(text: string, sourceType: string, writtenAt?: string)**:
       - POST to /api/fingerprint/corpus/add
       - Body: { text_content: text, source_type: sourceType, written_at: writtenAt }
       - Returns: FingerprintSampleResponse

    2. **corpus.getStatus()**:
       - GET from /api/fingerprint/corpus/status
       - Returns: CorpusStatus

    3. **corpus.getSamples(page?: number, pageSize?: number)**:
       - GET from /api/fingerprint/corpus/samples with query params
       - Returns: FingerprintSampleResponse[]

    4. **corpus.deleteSample(sampleId: number)**:
       - DELETE to /api/fingerprint/corpus/sample/{sampleId}
       - Returns: void

    5. **corpus.generateFingerprint(method?: string, alpha?: number)**:
       - POST to /api/fingerprint/corpus/generate
       - Body: { method, alpha }
       - Returns: EnhancedFingerprintResponse

    Extend FingerprintSampleResponse, CorpusStatus, EnhancedFingerprintResponse interfaces in api.ts if needed.
    Use consistent error handling with getErrorMessage helper.
  </action>
  <verify>
    Run: grep "corpus:" frontend/src/services/api.ts
    Verify: corpus.add, corpus.getStatus, corpus.getSamples, corpus.deleteSample, corpus.generateFingerprint defined
  </verify>
  <done>
    All corpus API methods defined with proper TypeScript types and error handling
  </done>
</task>

<task type="auto">
  <name>Task 4: Create CorpusBuilder React component</name>
  <files>frontend/src/components/ProfileManager/CorpusBuilder.tsx</files>
  <action>
    Create new component frontend/src/components/ProfileManager/CorpusBuilder.tsx:

    1. **State management**:
       - corpusStatus: CorpusStatus | null
       - samples: FingerprintSampleResponse[]
       - loading: boolean
       - selectedSourceType: string (dropdown: essay, academic, blog, email, document, manual)
       - uploadText: string (textarea for pasting text)

    2. **Key features**:
       - Progress indicator showing samples / 10 (with color coding: red <5, yellow 5-9, green 10+)
       - Source type distribution chart (simple bar showing count per source)
       - Sample list table with columns: Source Type, Date, Word Count, Preview, Delete button
       - File upload support (reuse existing file upload pattern from ProfileManager)
       - "Generate Enhanced Fingerprint" button (enabled when sample_count >= 10)

    3. **Actions**:
       - addSample(text, sourceType, writtenAt?) - calls corpus.add(), refreshes status
       - deleteSample(sampleId) - confirmation dialog, then corpus.deleteSample()
       - generateFingerprint() - calls corpus.generateFingerprint(), shows success toast

    4. **UI layout**:
       - Top: Status cards (Sample Count, Ready Status, Source Distribution)
       - Middle: Upload section with tabs (File Upload / Paste Text / Source Type selector)
       - Bottom: Sample list table with pagination
       - Floating "Generate Fingerprint" button when ready

    Use existing components: Card, Button, Badge, Alert, Textarea, Tabs
    Use icons from lucide-react: Upload, FileText, Trash2, CheckCircle, Sparkles
    Apply consistent styling with ProfileManager.tsx
  </action>
  <verify>
    Run: grep -E "(CorpusStatus|FingerprintSampleResponse|corpus\.)" frontend/src/components/ProfileManager/CorpusBuilder.tsx | wc -l
    Should find >10 matches (component uses corpus API)
  </verify>
  <done>
    Component renders without errors, displays corpus status, allows adding/deleting samples
  </done>
</task>

<task type="auto">
  <name>Task 5: Integrate CorpusBuilder into ProfileManager</name>
  <files>frontend/src/components/ProfileManager/ProfileManager.tsx</files>
  <action>
    Update frontend/src/components/ProfileManager/ProfileManager.tsx to integrate CorpusBuilder:

    1. Add import: import CorpusBuilder from './CorpusBuilder';

    2. Add new tab to existing Tabs component:
       - Insert after "Paste Text" tab: <TabsTrigger value="corpus">Enhanced Corpus</TabsTrigger>

    3. Add new TabsContent:
       ```tsx
       <TabsContent value="corpus">
         <CorpusBuilder />
       </TabsContent>
       ```

    4. Update recommendation card to mention enhanced fingerprint when applicable:
       - If sample_count >= 10: "You have enough samples for an enhanced fingerprint with time-weighted training"

    Keep existing functionality intact (single-sample upload, basic fingerprint generation).
  </action>
  <verify>
    Run: grep -E "(CorpusBuilder|corpus)" frontend/src/components/ProfileManager/ProfileManager.tsx
    Verify: CorpusBuilder imported and used in tabs
  </verify>
  <done>
    ProfileManager shows new "Enhanced Corpus" tab, CorpusBuilder renders correctly
  </done>
</task>

</tasks>

<verification>
1. API endpoints accessible: GET /api/fingerprint/corpus/status returns 200
2. Frontend renders corpus builder: Navigate to Profile tab, click "Enhanced Corpus" tab
3. Can add samples: Paste text, select source type, submit -> sample count increments
4. Progress indicator works: Shows 0/10, 5/10, 10/10 correctly
5. Generate button enables: When 10 samples reached, button becomes clickable
6. Sample list displays: Shows source type, date, word count for each sample
7. Delete sample works: Click delete -> sample removed from list
</verification>

<success_criteria>
- User can upload 10+ writing samples with source type metadata
- Corpus status shows sample count and distribution by source type
- System validates minimum 10 samples before enabling enhanced fingerprint generation
- User can view and delete individual samples from corpus
- Corpus builder UI accessible from ProfileManager
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-fingerprinting/05-02-SUMMARY.md` with:
- API endpoints added
- Frontend components created
- Any deviations from plan
- Performance notes (corpus query performance)
</output>
