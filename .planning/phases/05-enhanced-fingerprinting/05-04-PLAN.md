---
phase: 05-enhanced-fingerprinting
plan: 04
type: execute
wave: 3
depends_on: [05-03]
files_modified:
  - backend/app/models/schemas.py
  - backend/app/api/routes/fingerprint.py
  - backend/app/services/fingerprint_service.py
  - frontend/src/services/api.ts
  - frontend/src/components/ProfileManager/FingerprintProfile.tsx
  - frontend/src/components/ProfileManager/ProfileManager.tsx
autonomous: true

must_haves:
  truths:
    - "User can compare text to fingerprint with similarity score and confidence interval"
    - "Comparison API endpoint returns match level (HIGH/MEDIUM/LOW) based on thresholds"
    - "Fingerprint profile UI displays visual representation of fingerprint metadata"
    - "Similarity checker allows pasting text to compare against fingerprint"
    - "Feature deviations table shows which stylometric features differ most"
  artifacts:
    - path: "backend/app/models/schemas.py"
      provides: "FingerprintComparisonRequest, FingerprintComparisonResponse schemas"
    - path: "backend/app/api/routes/fingerprint.py"
      provides: "Comparison endpoint POST /api/fingerprint/compare"
      exports: ["compare_text_to_fingerprint"]
    - path: "backend/app/services/fingerprint_service.py"
      provides: "Service methods for fingerprint comparison"
      exports: ["compare_text_to_fingerprint", "get_fingerprint_profile"]
    - path: "frontend/src/services/api.ts"
      provides: "Frontend comparison API methods"
      exports: ["fingerprintAPI.compare", "fingerprintAPI.getProfile"]
    - path: "frontend/src/components/ProfileManager/FingerprintProfile.tsx"
      provides: "Visual fingerprint representation with similarity checker"
      min_lines: 150
  key_links:
    - from: "backend/app/api/routes/fingerprint.py"
      to: "FingerprintComparator"
      via: "compare_with_confidence method call"
      pattern: "compare_with_confidence\\("
    - from: "backend/app/services/fingerprint_service.py"
      to: "FingerprintComparator"
      via: "similarity calculation for comparison"
      pattern: "FingerprintComparator.*compare_with_confidence"
    - from: "frontend/src/components/ProfileManager/FingerprintProfile.tsx"
      to: "/api/fingerprint/compare"
      via: "fingerprintAPI.compare method"
      pattern: "fingerprintAPI\\.compare"
---

<objective>
Build fingerprint comparison API and UI with confidence intervals.

Purpose: Users need to verify if text matches their writing style. The comparison API uses the FingerprintComparator to compute similarity scores with confidence intervals and match levels. The UI displays visual fingerprint profile and provides an interactive similarity checker.

Output: Comparison API endpoint, FingerprintService methods, frontend API integration, and FingerprintProfile React component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enhanced-fingerprinting/05-enhanced-fingerprinting-RESEARCH.md

@.planning/phases/05-enhanced-fingerprinting/05-03-PLAN.md
@backend/app/ml/fingerprint/time_weighted_trainer.py
@backend/app/ml/fingerprint/similarity_calculator.py
@backend/app/api/routes/fingerprint.py
@backend/app/services/fingerprint_service.py
@frontend/src/services/api.ts
@frontend/src/components/ProfileManager/ProfileManager.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comparison schemas to schemas.py</name>
  <files>backend/app/models/schemas.py</files>
  <action>
    Add to backend/app/models/schemas.py (after FingerprintComparisonResponse placeholder, before Analysis Schemas):

    1. **FingerprintComparisonRequest**:
       ```python
       class FingerprintComparisonRequest(BaseModel):
           text: str = Field(..., min_length=10)
           use_enhanced: bool = Field(default=True, description="Use enhanced fingerprint if available")
       ```

    2. **FeatureDeviation** (nested model):
       ```python
       class FeatureDeviation(BaseModel):
           feature: str
           text_value: float
           fingerprint_value: float
           deviation: float
       ```

    3. **ConfidenceInterval**:
       ```python
       class ConfidenceInterval(BaseModel):
           lower: float
           upper: float
       ```

    4. **FingerprintComparisonResponse**:
       ```python
       class FingerprintComparisonResponse(BaseModel):
           similarity: float = Field(..., ge=0.0, le=1.0)
           confidence_interval: ConfidenceInterval
           match_level: str = Field(..., pattern="^(HIGH|MEDIUM|LOW)$")
           feature_deviations: List[FeatureDeviation]
           method_used: str  # "time_weighted_ema", "average", or "basic"
           corpus_size: Optional[int] = None
       ```

    These schemas enable type-safe API requests/responses for fingerprint comparison.
  </action>
  <verify>
    Run: python -c "from app.models.schemas import FingerprintComparisonRequest, FingerprintComparisonResponse; print('Schemas imported')"
  </verify>
  <done>
    Schemas validate correctly, match_level pattern enforced
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comparison API endpoint</name>
  <files>backend/app/api/routes/fingerprint.py</files>
  <action>
    Add to backend/app/api/routes/fingerprint.py:

    1. **Add new schema to imports**:
       - from app.models.schemas import FingerprintComparisonRequest, FingerprintComparisonResponse

    2. **POST /api/fingerprint/compare** endpoint:
       ```python
       @router.post("/compare", response_model=FingerprintComparisonResponse)
       async def compare_text_to_fingerprint(
           request: FingerprintComparisonRequest,
           current_user: User = Depends(get_current_user),
           db: Session = Depends(get_db)
       ):
           """
           Compare text to user's fingerprint with confidence intervals.

           Returns similarity score, confidence interval, match level,
           and which features differ most.
           """
       ```
       - Get user's EnhancedFingerprint if use_enhanced=True, else basic Fingerprint
       - If no fingerprint: raise 404 with helpful message
       - Extract features from text using extract_feature_vector
       - Use FingerprintComparator to compare
       - Return FingerprintComparisonResponse

    3. **GET /api/fingerprint/profile** endpoint (optional but useful):
       - Returns user's enhanced fingerprint with metadata
       - Includes: corpus_size, method, alpha, source_distribution, date_range

    Import: from app.ml.fingerprint.similarity_calculator import FingerprintComparator
    Import: from app.ml.feature_extraction import extract_feature_vector
  </action>
  <verify>
    Run: python -c "from app.api.routes.fingerprint import router; routes = [p.path for p in router.routes if 'compare' in p.path]; print(routes)"
    Output should include: /api/fingerprint/compare
  </verify>
  <done>
    POST /compare endpoint accepts text, returns similarity with confidence interval
  </done>
</task>

<task type="auto">
  <name>Task 3: Add comparison methods to FingerprintService</name>
  <files>backend/app/services/fingerprint_service.py</files>
  <action>
    Extend FingerprintService in backend/app/services/fingerprint_service.py:

    1. **compare_text_to_fingerprint(self, db, user_id, text, use_enhanced=True)**:
       - If use_enhanced: query EnhancedFingerprint first, fall back to basic Fingerprint
       - If no fingerprint exists: raise ValueError("No fingerprint found")
       - Extract features from text: extract_feature_vector(text)
       - Initialize FingerprintComparator with confidence_level=0.95
       - Get feature_statistics from enhanced fingerprint if available
       - Call comparator.compare_with_confidence(text_features, fingerprint_dict, stats)
       - Return dict matching FingerprintComparisonResponse schema

    2. **get_fingerprint_profile(self, db, user_id)**:
       - Query EnhancedFingerprint for user
       - If not found, fall back to basic Fingerprint
       - Return dict with: feature_vector, corpus_size, method, alpha, source_distribution, created_at, updated_at

    Import: from app.ml.fingerprint.similarity_calculator import FingerprintComparator
    Import: from app.ml.feature_extraction import extract_feature_vector
    Import: from app.models.database import EnhancedFingerprint
  </action>
  <verify>
    Run: python -c "from app.services.fingerprint_service import get_fingerprint_service; fs = get_fingerprint_service(); print(hasattr(fs, 'compare_text_to_fingerprint'))"
    Output: True
  </verify>
  <done>
    Service methods integrate with FingerprintComparator, handle enhanced/basic fallback
  </done>
</task>

<task type="auto">
  <name>Task 4: Add comparison API to frontend</name>
  <files>frontend/src/services/api.ts</files>
  <action>
    Extend fingerprintAPI in frontend/src/services/api.ts:

    1. **compare(text: string, useEnhanced: boolean = true)**:
       - POST to /api/fingerprint/compare
       - Body: { text, use_enhanced: useEnhanced }
       - Returns: FingerprintComparisonResponse

    2. **getProfile()**:
       - GET from /api/fingerprint/profile
       - Returns: Enhanced fingerprint profile with metadata

    Add TypeScript interfaces for these responses:
    ```typescript
    interface ConfidenceInterval {
      lower: number;
      upper: number;
    }

    interface FeatureDeviation {
      feature: string;
      text_value: number;
      fingerprint_value: number;
      deviation: number;
    }

    interface FingerprintComparisonResponse {
      similarity: number;
      confidence_interval: ConfidenceInterval;
      match_level: 'HIGH' | 'MEDIUM' | 'LOW';
      feature_deviations: FeatureDeviation[];
      method_used: string;
      corpus_size?: number;
    }

    interface FingerprintProfile {
      corpus_size: number;
      method: string;
      alpha: number;
      source_distribution: Record<string, number>;
      created_at: string;
      updated_at: string;
    }
    ```
  </action>
  <verify>
    Run: grep "compare(" frontend/src/services/api.ts
    Verify: fingerprintAPI.compare method exists
  </verify>
  <done>
    Frontend API methods defined with proper TypeScript types
  </done>
</task>

<task type="auto">
  <name>Task 5: Create FingerprintProfile visual component</name>
  <files>frontend/src/components/ProfileManager/FingerprintProfile.tsx</files>
  <action>
    Create frontend/src/components/ProfileManager/FingerprintProfile.tsx:

    1. **Component features**:
       - Display fingerprint metadata: corpus_size, method, alpha, created_at, updated_at
       - Visual representation of 27-feature vector as a radar-like chart or bar chart
       - Source distribution visualization (pie or bar chart)
       - Similarity checker: paste text to compare against fingerprint

    2. **Similarity checker section**:
       - Textarea for input text
       - "Check Similarity" button
       - Results display:
         * Similarity score (0-100%) with color coding (green >0.85, yellow >0.70, red <0.70)
         * Confidence interval: "X% to Y%" range
         * Match level badge (HIGH/MEDIUM/LOW)
         * Feature deviations table: top 5 differing features with text vs fingerprint values

    3. **State**:
       - profile: FingerprintProfile | null
       - comparisonText: string
       - comparisonResult: FingerprintComparisonResponse | null
       - loading: boolean

    4. **Actions**:
       - loadProfile() on mount
       - checkSimilarity() calls fingerprintAPI.compare()
       - Display error if no fingerprint exists

    Use existing UI components: Card, Button, Badge, Alert, Textarea, ProgressBar
    Use icons: Fingerprint, Target, Sparkles from lucide-react
    Apply consistent dark mode styling
  </action>
  <verify>
    Run: grep -E "(FingerprintProfile|similarity|comparison)" frontend/src/components/ProfileManager/FingerprintProfile.tsx | wc -l
    Should find >15 matches
  </verify>
  <done>
    Component displays fingerprint profile, similarity checker works with text input
  </done>
</task>

<task type="auto">
  <name>Task 6: Integrate FingerprintProfile into ProfileManager</name>
  <files>frontend/src/components/ProfileManager/ProfileManager.tsx</files>
  <action>
    Update frontend/src/components/ProfileManager/ProfileManager.tsx:

    1. Add import: import FingerprintProfile from './FingerprintProfile';

    2. Add new tab after "Enhanced Corpus":
       ```tsx
       <TabsTrigger value="profile">Fingerprint Profile</TabsTrigger>
       ```

    3. Add corresponding TabsContent:
       ```tsx
       <TabsContent value="profile">
         <FingerprintProfile />
       </TabsContent>
       ```

    4. Update tab order if needed to show logical flow:
       - Upload File / Paste Text (existing)
       - Enhanced Corpus (05-02)
       - Fingerprint Profile (this task)
       - Fine-tune (existing, shown only when has_fingerprint)

    The Profile tab should be accessible only when user has a fingerprint (basic or enhanced).
    Add conditional: {status?.has_fingerprint && <TabsTrigger value="profile">Fingerprint Profile</TabsTrigger>}
  </action>
  <verify>
    Run: grep "FingerprintProfile" frontend/src/components/ProfileManager/ProfileManager.tsx
    Verify: Component imported and used in tabs
  </verify>
  <done>
    ProfileManager shows Fingerprint Profile tab when user has fingerprint
  </done>
</task>

</tasks>

<verification>
1. API endpoints work:
   - POST /api/fingerprint/compare with text returns 200 with similarity score
   - Response includes confidence_interval and feature_deviations
2. Frontend displays comparison results:
   - Navigate to Profile -> Fingerprint Profile tab
   - Paste text, click "Check Similarity"
   - See similarity %, confidence interval, match level badge
3. Match levels align with thresholds:
   - Similarity >0.85 shows "HIGH" badge (green)
   - Similarity 0.70-0.85 shows "MEDIUM" badge (yellow)
   - Similarity <0.70 shows "LOW" badge (red)
4. Feature deviations display: Table shows top 5 differing features
</verification>

<success_criteria>
- Fingerprint comparison returns similarity score with 95% confidence interval
- Match level classification uses thresholds: HIGH >=0.85, MEDIUM >=0.70, LOW <0.70
- Feature deviations highlight which stylometric features differ most
- User can interactively compare text to their fingerprint via UI
- Fingerprint profile displays metadata (corpus_size, method, alpha, source_distribution)
</success_criteria>

<output>
After completion, create `.planning/phases/05-enhanced-fingerprinting/05-04-SUMMARY.md` with:
- EMA alpha value and recency calculation details
- Similarity threshold values and match level behavior
- Confidence interval calculation method (z-score, SEM)
- Any deviations from research recommendations
- Performance notes for similarity calculations
</output>
