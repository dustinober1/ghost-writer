---
phase: 02-batch-analysis
plan: 02
type: tdd
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/app/services/batch_analysis_service.py
  - backend/tests/test_batch_analysis_service.py
autonomous: true
---

<objective>
Implement batch similarity clustering and comparison matrix generation with deterministic behavior.

Purpose: Provide the core clustering and pairwise similarity outputs required for batch insights.
Output: BatchAnalysisService with clustering + similarity utilities and full pytest coverage.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
@~/.config/opencode/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-batch-analysis/02-CONTEXT.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/TESTING.md
@backend/app/services/analysis_service.py
</context>

<feature>
  <name>Batch document clustering and similarity matrix</name>
  <files>backend/app/services/batch_analysis_service.py, backend/tests/test_batch_analysis_service.py</files>
  <behavior>
    Given a list of embeddings (list[list[float]]) aligned with document IDs, the service should:
    - Build a symmetric similarity matrix with cosine similarity scores (0.0 to 1.0) and diagonal = 1.0
    - Cluster documents using a simple deterministic threshold (default 0.85) where docs with similarity >= threshold share a cluster_id
    - Return clusters as list of {cluster_id, document_ids, avg_similarity}
    Cases:
    - Two identical vectors -> similarity 1.0, same cluster
    - Orthogonal vectors -> similarity near 0.0, separate clusters
    - Empty input -> returns empty matrix and empty clusters
  </behavior>
  <implementation>
    Create BatchAnalysisService with methods: build_similarity_matrix(embeddings), cluster_documents(embeddings, threshold=0.85), and summarize_clusters(similarity_matrix, clusters). Use numpy for cosine similarity and deterministic cluster assignment (single-pass union of docs meeting threshold). Avoid external ML clustering libraries to keep dependencies unchanged. Ensure outputs are JSON-serializable (lists of floats/ints, no numpy types).
  </implementation>
</feature>

<verification>
- cd backend && pytest tests/test_batch_analysis_service.py
</verification>

<success_criteria>
- Failing tests written for similarity matrix and clustering edge cases
- Implementation passes tests and keeps JSON-serializable output
- No new dependencies added
- TDD commits follow RED/GREEN/REFACTOR sequence
</success_criteria>

<output>
After completion, create `.planning/phases/02-batch-analysis/02-02-SUMMARY.md` with RED/GREEN/REFACTOR notes and commits.
</output>
