---
phase: 01-explainability
plan: 04
type: execute
wave: 3
depends_on: [01-01]
files_modified:
  - backend/app/services/analysis_service.py
  - backend/app/models/schemas.py
  - frontend/src/components/HeatMap/HeatMap.tsx
autonomous: false
must_haves:
  truths:
    - "User can view overused phrases and patterns that triggered detection, with specific examples highlighted in the text"
    - "System detects repeated phrases, sentence structures, and word patterns within the document"
    - "Overused patterns are stored in analysis result with locations and frequency counts"
    - "Frontend highlights overused patterns with visual indicators in the text"
  artifacts:
    - path: "backend/app/services/analysis_service.py"
      provides: "Overused pattern detection and storage"
      exports: ["detect_overused_patterns"]
    - path: "backend/app/models/schemas.py"
      provides: "OverusedPattern schema for pattern matches"
      contains: "class OverusedPattern"
    - path: "frontend/src/components/HeatMap/HeatMap.tsx"
      provides: "Pattern highlighting in text display"
      contains: "highlightOverusedPatterns"
  key_links:
    - from: "backend/app/services/analysis_service.py"
      to: "detect_overused_patterns"
      via: "Pattern detection algorithm on full text"
      pattern: "detect_overused_patterns.*text"
    - from: "frontend/src/components/HeatMap/HeatMap.tsx"
      to: "analysisResult.overused_patterns"
      via: "Highlight patterns in segment rendering"
      pattern: "overused_patterns.*highlight"
---

<objective>
Detect and highlight overused phrases and patterns that contribute to AI detection.

Purpose: AI-generated content often contains repetitive phrases, sentence structures, and word patterns. By detecting these patterns and showing them to users, we provide concrete evidence of why content was flagged and help users understand specific issues to address.

Output: Pattern detection system that identifies repeated phrases, sentence structures, and word patterns, with visual highlighting in the UI showing where these patterns occur.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

@backend/app/services/analysis_service.py
@backend/app/models/schemas.py
@frontend/src/components/HeatMap/HeatMap.tsx

# Reference 01-01-SUMMARY.md for confidence system context
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement overused pattern detection algorithm</name>
  <files>backend/app/services/analysis_service.py</files>
  <action>
    Add overused pattern detection:

    1. Create detect_overused_patterns(text: str, segments: List[Dict]) -> List[Dict]:
       - Analyzes full text for repetitive patterns across multiple dimensions
       - Returns list of detected patterns with locations and frequency

    2. Pattern detection dimensions:
       a) Repeated phrases (n-grams):
          - Extract 2-word, 3-word, and 4-word phrases
          - Count occurrences across document
          - Flag phrases appearing 3+ times as overused
          - Store: phrase, count, locations (start indices)

       b) Sentence structure patterns:
          - Analyze sentence length patterns
          - Detect repeated sentence starts (e.g., "The...", "This...", "In...")
          - Flag if >30% sentences start with same word pattern
          - Store: pattern_type, start_word, percentage, examples

       c) Word repetition patterns:
          - Identify words used frequently (excluding common stopwords)
          - Calculate word frequency distribution
          - Flag words appearing >5% of total word count
          - Store: word, frequency, percentage, locations

    3. Algorithm approach:
       - Use nltk or spaCy for tokenization (already in dependencies)
       - Use collections.Counter for frequency counting
       - Use regex for pattern matching
       - NO machine learning needed - statistical analysis only

    4. Return format:
      ```python
      [
        {
          "pattern_type": "repeated_phrase",
          "pattern": "in order to",
          "count": 4,
          "locations": [45, 178, 312, 445],
          "severity": "high"  # based on count
        },
        {
          "pattern_type": "sentence_start",
          "pattern": "The",
          "count": 8,
          "percentage": 0.40,
          "severity": "medium"
        },
        ...
      ]
      ```

    5. Integrate into analyze_text():
       - Call detect_overused_patterns() after segment analysis
       - Add "overused_patterns" field to result dictionary
  </action>
  <verify>
    Run: python -c "from backend.app.services.analysis_service import get_analysis_service; service = get_analysis_service(); result = service.analyze_text('The cat sat. The dog ran. The bird flew. The fish swam.', 'sentence'); print('Patterns:', result.get('overused_patterns', 'NOT FOUND'))"
    Expected: overused_patterns contains sentence_start pattern for "The" with count=4
  </verify>
  <done>
    - detect_overused_patterns() function exists
    - Detects repeated phrases (2-4 word n-grams)
    - Detects sentence structure patterns (repeated starts)
    - Detects word repetition patterns
    - Returns patterns with locations, counts, severity
    - overused_patterns included in analyze_text() result
  </done>
</task>

<task type="auto">
  <name>Task 2: Add overused pattern schemas</name>
  <files>backend/app/models/schemas.py</files>
  <action>
    1. In backend/app/models/schemas.py:
       - Add PatternType enum: REPEATED_PHRASE, SENTENCE_START, WORD_REPETITION
       - Add PatternSeverity enum: HIGH, MEDIUM, LOW

       - Add OverusedPattern schema:
         ```python
         class OverusedPattern(BaseModel):
           pattern_type: PatternType
           pattern: str  # The actual repeated text
           count: int  # Number of occurrences
           locations: List[int]  # Start indices in text
           severity: PatternSeverity
           percentage: Optional[float] = None  # For sentence starts/word freq
           examples: Optional[List[str]] = None  # Sample occurrences
         ```

       - Extend HeatMapData:
         ```python
         class HeatMapData(BaseModel):
           segments: List[TextSegment]
           overall_ai_probability: float
           confidence_distribution: Optional[Dict[str, int]] = None
           document_explanation: Optional[str] = None
           overused_patterns: Optional[List[OverusedPattern]] = None
         ```

    2. Ensure API response includes overused_patterns field (automatic via Pydantic)

    3. Add validation:
       - count must be >= 2
       - locations cannot be empty
       - severity must be valid enum value
  </action>
  <verify>
    Run: curl -X POST http://localhost:8000/api/analysis/analyze -H "Content-Type: application/json" -d '{"text": "The cat sat. The dog ran. The bird flew. The fish swam.", "granularity": "sentence"}' | jq '.heat_map_data.overused_patterns'
    Expected: overused_patterns is array with at least one pattern object
  </verify>
  <done>
    - PatternType and PatternSeverity enums defined
    - OverusedPattern schema with all required fields
    - HeatMapData includes overused_patterns field
    - API responses include overused_patterns
    - Schema validation passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Backend overused pattern detection system</what-built>
  <how-to-verify>
    1. Start backend: docker-compose up backend
    2. Submit varied texts for analysis:
       - Text with repeated phrases: "in order to" appearing multiple times
       - Text with repetitive sentence starts: Most sentences starting with "The"
       - Text with word repetition: Same adjective used repeatedly

    3. Check API response in DevTools:
       - heat_map_data.overused_patterns exists
       - Patterns are categorized by type (phrase, sentence_start, word_repetition)
       - Each pattern has: count, locations, severity
       - Locations are valid indices in the original text

    4. Verify detection accuracy:
       - Repeated phrases: Should detect exact matches of 2-4 word sequences
       - Sentence starts: Should catch "The", "This", "In" repetition
       - Word repetition: Should flag words >5% of total

    Expected: Pattern detection accurately identifies repetitive structures without false positives
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues with pattern detection accuracy/algorithm</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create frontend pattern highlighting UI</name>
  <files>frontend/src/components/HeatMap/HeatMap.tsx</files>
  <action>
    Add overused pattern visualization to HeatMap component:

    1. Update interfaces:
       ```typescript
       interface OverusedPattern {
         pattern_type: 'REPEATED_PHRASE' | 'SENTENCE_START' | 'WORD_REPETITION';
         pattern: string;
         count: number;
         locations: number[];
         severity: 'HIGH' | 'MEDIUM' | 'LOW';
         percentage?: number;
         examples?: string[];
       }
       interface HeatMapData {
         segments: TextSegment[];
         overall_ai_probability: number;
         document_explanation?: string;
         overused_patterns?: OverusedPattern[];
       }
       ```

    2. Add "Repetitive Patterns" card (below Document Explanation, above segments):
       - Title: "Repetitive Patterns Detected"
       - Icon: Alert or Repeat
       - List top 5 patterns by severity/count
       - For each pattern:
         - Show pattern text (highlighted)
         - Show count: "Used X times"
         - Show severity badge (HIGH=red, MEDIUM=yellow, LOW=gray)
         - Click to scroll to first occurrence in text

    3. Enhance segment rendering to highlight patterns:
       - When rendering segments, check if any overused_pattern locations fall within segment
       - Add underline or highlight styling to matched text
       - Color code by severity (red=HIGH, yellow=MEDIUM, gray=LOW)
       - Add tooltip on hover: "Repeated phrase: 'in order to' (used 4 times)"

    4. Pattern summary statistics:
       - If overused_patterns exists, show summary in Statistics card
       - "X repetitive patterns found"
       - Breakdown by type: "Y phrases, Z sentence starts"

    5. Visual design:
       - Highlights should be visible but not overwhelming (subtle underline + background tint)
       - Pattern card should be dismissible (user can hide if not needed)
       - Use consistent severity colors with confidence badges

    6. Handle edge cases:
       - No patterns: Don't show pattern card
       - Too many patterns (>10): Show top 10 + "and X more"
       - Overlapping patterns: Show most severe highlight

    Ensure pattern highlighting enhances understanding without cluttering the text view.
  </action>
  <verify>
    Run: npm run build (no TypeScript errors)
    Run: npm run test (if tests exist)
    Check: HeatMap.tsx renders OverusedPattern card
    Check: Segment rendering includes pattern highlighting logic
  </verify>
  <done>
    - OverusedPattern card displays below document explanation
    - Top patterns listed with severity badges
    - Pattern text is highlighted in segments with color coding
    - Tooltips show pattern details on hover
    - Statistics include pattern summary
    - UI is not cluttered
    - Highlights are visible and informative
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete overused pattern visualization system</what-built>
  <how-to-verify>
    1. Start full application: docker-compose up
    2. Navigate to /analyze and submit text with repetitive patterns

    3. Verify "Repetitive Patterns Detected" card:
       - Appears below document explanation
       - Lists top patterns with counts and severity
       - Patterns are sorted by severity/count
       - Clicking pattern scrolls to first occurrence

    4. Verify text highlighting:
       - Repeated phrases are underlined/highlighted in the text
       - Severity color coding is visible (red=high, yellow=medium)
       - Hovering over highlight shows tooltip with details
       - Highlights don't make text hard to read

    5. Test with different texts:
       - Text with many repeated phrases: Should show multiple highlights
       - Text with no repetition: Pattern card should not appear
       - AI-generated text: Typically shows patterns (sentence starts, phrases)

    6. Test interactivity:
       - Click pattern in card -> scrolls to location
       - Hover highlight -> shows tooltip
       - Dismiss card -> hides pattern information

    Expected: Users can see concrete examples of repetitive patterns that contributed to AI detection
  </how-to-verify>
  <resume-signal>Type "approved" or describe UX issues with pattern highlighting/display</resume-signal>
</task>

</tasks>

<verification>
1. Backend detects repeated phrases (2-4 word n-grams) with 3+ occurrences
2. Backend detects sentence structure patterns (repeated starts)
3. Backend detects word repetition patterns (high-frequency words)
4. Pattern detection returns locations, counts, and severity
5. Frontend displays pattern summary card with top patterns
6. Frontend highlights patterns in text with severity color coding
7. User can click patterns to navigate to examples
8. Pattern information enhances understanding of AI detection
</verification>

<success_criteria>
- [ ] detect_overused_patterns() function implemented
- [ ] OverusedPattern schema defined with all fields
- [ ] HeatMapData includes overused_patterns field
- [ ] Pattern detection identifies phrases, sentence starts, word repetition
- [ ] Frontend displays "Repetitive Patterns Detected" card
- [ ] Patterns are highlighted in text with color coding
- [ ] Tooltips show pattern details on hover
- [ ] User can navigate to pattern examples
- [ ] Pattern detection is accurate with minimal false positives
</success_criteria>

<output>
After completion, create `.planning/phases/01-explainability/01-04-SUMMARY.md`
</output>
