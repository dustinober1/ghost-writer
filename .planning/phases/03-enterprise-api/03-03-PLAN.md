---
phase: 03-enterprise-api
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - backend/app/main.py
  - backend/app/api/routes/docs.py
autonomous: true

must_haves:
  truths:
    - "Anonymous users cannot access /docs or /redoc (returns 401)"
    - "Authenticated users (JWT or API key) can view OpenAPI documentation"
    - "OpenAPI schema at /openapi.json requires authentication"
    - "Production environment has public docs disabled by default"
    - "Development mode can optionally allow public docs for convenience"
  artifacts:
    - path: "backend/app/api/routes/docs.py"
      provides: "Protected OpenAPI/Swagger/ReDoc endpoints"
      exports: ["GET /docs", "GET /redoc", "GET /openapi.json"]
    - path: "backend/app/main.py"
      provides: "FastAPI app with docs_url=None, redoc_url=None, openapi_url=None"
      contains: "docs_url=None"
  key_links:
    - from: "backend/app/api/routes/docs.py"
      to: "backend/app/utils/auth.py"
      via: "get_current_user_or_api_key dependency"
      pattern: "Depends\\(get_current_user_or_api_key\\)"
    - from: "backend/app/api/routes/docs.py"
      to: "fastapi.openapi.utils"
      via: "get_openapi function call"
      pattern: "get_openapi\\("
---

<objective>
Protected OpenAPI Documentation - API documentation requires authentication, preventing public exposure of API structure while enabling authenticated developers to explore endpoints.

Purpose: Reduce attack surface by hiding API structure from unauthenticated users while maintaining convenient developer experience for legitimate API users. Production best practice is to protect documentation.

Output: Authenticated /docs, /redoc, and /openapi.json endpoints
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-enterprise-api/03-RESEARCH.md
@.planning/phases/03-enterprise-api/03-01-SUMMARY.md

@backend/app/main.py
@backend/app/utils/auth.py
@backend/app/api/routes/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Disable default OpenAPI docs and create protected docs router</name>
  <files>backend/app/main.py</files>
  <action>
    1. First, modify the FastAPI app initialization to disable default public docs:

    Find the `app = FastAPI(...)` call and add/modify these parameters:
    ```python
    app = FastAPI(
        title="Ghostwriter Forensic Analytics API",
        description="""
        ## Overview

        Ghostwriter is a forensic analytics platform for stylometric fingerprinting and AI text detection.
        Use local LLMs (Ollama) to analyze text patterns and distinguish between human and AI-generated content.

        ## Authentication

        This API requires authentication for all endpoints including documentation.

        **Web UI Authentication:** Use JWT tokens from `/api/auth/login`
        **API Access:** Use API keys from `/api/keys` with `X-API-Key` header

        Rate limits are enforced per user based on subscription tier.
        """,
        version="1.0.0",
        docs_url=None,  # Disable public docs
        redoc_url=None,  # Disable public redoc
        openapi_url=None,  # Disable public schema
        contact={
            "name": "Ghostwriter Support",
            "email": "support@ghostwriter.local",
        },
        license_info={
            "name": "MIT",
        },
    )
    ```

    2. Import the docs router (add to imports section):
    ```python
    from app.api.routes import auth, analysis, fingerprint, rewrite, analytics, account, admin, batch, api_keys, api_usage, docs
    ```

    3. Include the docs router (after other routers):
    ```python
    app.include_router(docs.router)
    ```

    The docs router will be created in the next task.
  </action>
  <verify>grep -n "docs_url=None" backend/app/main.py returns the FastAPI config line</verify>
  <done>FastAPI app configured with docs_url=None, redoc_url=None, openapi_url=None</done>
</task>

<task type="auto">
  <name>Task 2: Create protected documentation router</name>
  <files>backend/app/api/routes/docs.py</files>
  <action>
    Create new file backend/app/api/routes/docs.py:

    ```python
    from fastapi import APIRouter, Depends
    from fastapi.openapi.docs import get_swagger_ui_html, get_redoc_html
    from fastapi.openapi.utils import get_openapi
    from app.utils.auth import get_current_user_or_api_key
    from app.models.database import User

    router = APIRouter(tags=["documentation"])


    @router.get("/docs", include_in_schema=False)
    async def get_swagger_documentation(
        current_user: User = Depends(get_current_user_or_api_key)
    ):
        """
        Swagger UI documentation - requires authentication.

        Use your JWT token from login or API key to access.
        """
        from app.main import app
        return get_swagger_ui_html(
            openapi_url="/openapi.json",
            title=f"{app.title} - Swagger UI",
            swagger_favicon_url=""
        )


    @router.get("/redoc", include_in_schema=False)
    async def get_redoc_documentation(
        current_user: User = Depends(get_current_user_or_api_key)
    ):
        """
        ReDoc documentation - requires authentication.

        Use your JWT token from login or API key to access.
        """
        from app.main import app
        return get_redoc_html(
            openapi_url="/openapi.json",
            title=f"{app.title} - ReDoc"
        )


    @router.get("/openapi.json", include_in_schema=False)
    async def get_openapi_schema(
        current_user: User = Depends(get_current_user_or_api_key)
    ):
        """
        OpenAPI schema - requires authentication.

        Returns the full OpenAPI 3.0 specification for this API.
        """
        from app.main import app

        if app.openapi_schema:
            return app.openapi_schema

        from app.middleware.rate_limit import TIER_LIMITS

        # Generate OpenAPI schema with additional info
        openapi_schema = get_openapi(
            title=app.title,
            version=app.version,
            routes=app.routes,
            description=app.description
        )

        # Add rate limit information to the schema
        openapi_schema["info"]["x-rate-limits"] = {
            "free": TIER_LIMITS["free"],
            "pro": TIER_LIMITS["pro"],
            "enterprise": TIER_LIMITS["enterprise"]
        }

        # Add security schemes
        openapi_schema["components"]["securitySchemes"] = {
            "BearerAuth": {
                "type": "http",
                "scheme": "bearer",
                "bearerFormat": "JWT",
                "description": "JWT token from /api/auth/login-json"
            },
            "ApiKeyAuth": {
                "type": "apiKey",
                "in": "header",
                "name": "X-API-Key",
                "description": "API key from /api/keys"
            }
        }

        # Set default security
        for path in openapi_schema["paths"].values():
            for method in path.values():
                if "security" not in method:
                    # Allow either auth method
                    method["security"] = [{"BearerAuth": []}, {"ApiKeyAuth": []}]

        app.openapi_schema = openapi_schema
        return app.openapi_schema
    ```

    This creates protected documentation endpoints that require authentication.
  </action>
  <verify>grep -n "router = APIRouter" backend/app/api/routes/docs.py returns router definition</verify>
  <done>docs.py created with protected /docs, /redoc, /openapi.json endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Add optional development mode public docs</name>
  <files>backend/app/main.py</files>
  <action>
    Add conditional public docs for development convenience.

    After the FastAPI app definition, add:

    ```python
    # In development mode, optionally provide public docs for convenience
    # Set ENVIRONMENT=development and ENABLE_PUBLIC_DOCS=true to enable
    if os.getenv("ENVIRONMENT") == "development" and os.getenv("ENABLE_PUBLIC_DOCS", "").lower() == "true":
        @app.get("/dev-docs", include_in_schema=False)
        async def dev_docs():
            \"\"\"Public docs in development mode only\"\"\"
            from fastapi.openapi.docs import get_swagger_ui_html
            return get_swagger_ui_html(
                openapi_url="/dev-openapi.json",
                title=f"{app.title} - Dev Docs (Public)"
            )

        @app.get("/dev-openapi.json", include_in_schema=False)
        async def dev_openapi():
            \"\"\"Public OpenAPI schema in development mode only\"\"\"
            from fastapi.openapi.utils import get_openapi
            return get_openapi(title=app.title, version=app.version, routes=app.routes)
    ```

    This allows public docs in development when explicitly enabled via environment variable.
  </action>
  <verify>grep -n "dev-docs" backend/app/main.py returns the conditional dev endpoint</verify>
  <done>Optional public docs available in development mode with ENABLE_PUBLIC_DOCS=true</done>
</task>

</tasks>

<verification>
1. Restart backend: `docker-compose restart backend`
2. Test unauthenticated access (should fail):
   ```bash
   curl -i http://localhost:8000/docs
   ```
   Should return 401 or redirect to login

3. Test authenticated access with JWT (should succeed):
   ```bash
   TOKEN=$(curl -X POST http://localhost:8000/api/auth/login-json \
     -H "Content-Type: application/json" \
     -d '{"email":"test@example.com","password":"testpass123"}' | jq -r '.access_token')

   curl http://localhost:8000/docs \
     -H "Authorization: Bearer $TOKEN" | head -20
   ```
   Should return Swagger UI HTML

4. Test authenticated access with API key (should succeed):
   ```bash
   KEY=$(curl -X POST http://localhost:8000/api/keys \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"name":"Test"}' | jq -r '.key')

   curl http://localhost:8000/openapi.json \
     -H "X-API-Key: $KEY" | jq '.info.title'
   ```
   Should return OpenAPI schema with "Ghostwriter Forensic Analytics API"

5. Verify security schemes are documented:
   ```bash
   curl http://localhost:8000/openapi.json \
     -H "X-API-Key: $KEY" | jq '.components.securitySchemes'
   ```
   Should show BearerAuth and ApiKeyAuth
</verification>

<success_criteria>
1. Default docs are disabled (docs_url=None)
2. Unauthenticated requests to /docs return 401
3. Authenticated requests to /docs return Swagger UI
4. Authenticated requests to /redoc return ReDoc
5. Authenticated requests to /openapi.json return valid OpenAPI schema
6. OpenAPI schema includes both BearerAuth and ApiKeyAuth security schemes
7. Optional public docs work in development with ENABLE_PUBLIC_DOCS=true
</success_criteria>

<output>
After completion, create `.planning/phases/03-enterprise-api/03-03-SUMMARY.md`
</output>
